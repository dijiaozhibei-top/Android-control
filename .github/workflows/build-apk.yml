name: Build Android APK

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'android-client/**'
      - '.github/workflows/build-apk.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'android-client/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Grant execute permission for gradlew
      run: |
        cd android-client
        chmod +x gradlew
        ls -la gradlew

    - name: List android-client directory
      run: |
        echo "=== Root directory ==="
        ls -la
        echo ""
        echo "=== android-client directory ==="
        ls -la android-client
        echo ""
        echo "=== gradle/wrapper directory ==="
        ls -la android-client/gradle/wrapper || echo "gradle/wrapper not found"

    - name: Check Gradle wrapper
      run: |
        cd android-client
        echo "=== Checking gradlew ==="
        ./gradlew --version

    - name: Accept Android SDK licenses
      run: |
        yes | sdkmanager --licenses || true

    - name: Build Debug APK
      run: |
        cd android-client
        echo "=== Building Debug APK ==="
        ./gradlew assembleDebug --stacktrace --info || ./gradlew assembleDebug --stacktrace --debug

    - name: Check Debug APK exists
      run: |
        echo "=== Checking for APK files ==="
        find android-client -name "*.apk" -type f || echo "No APK files found"
        ls -la android-client/app/build/outputs/apk/debug/ 2>/dev/null || echo "Debug directory not found"

    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: android-control-debug
        path: |
          android-client/app/build/outputs/apk/debug/*.apk
          android-client/app/build/outputs/apk/debug/**/*.apk
        retention-days: 30
        if-no-files-found: error

    - name: Build Release APK (unsigned)
      run: |
        cd android-client
        echo "=== Building Release APK ==="
        ./gradlew assembleRelease --stacktrace --info || ./gradlew assembleRelease --stacktrace --debug

    - name: Check Release APK exists
      run: |
        echo "=== Checking for Release APK files ==="
        ls -la android-client/app/build/outputs/apk/release/ 2>/dev/null || echo "Release directory not found"

    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: android-control-release
        path: |
          android-client/app/build/outputs/apk/release/*.apk
          android-client/app/build/outputs/apk/release/**/*.apk
        retention-days: 30
        if-no-files-found: warn

    - name: Get version info
      id: version
      run: |
        cd android-client
        VERSION_NAME=$(grep "versionName" app/build.gradle.kts | head -1 | awk '{print $3}' | tr -d '"')
        echo "version=${VERSION_NAME}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION_NAME}"

    - name: Create Release (on main branch)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: Android Control v${{ steps.version.outputs.version }}
        body: |
          ## Androidè¿œç¨‹æ§åˆ¶APKå‘å¸ƒ
          
          ### åŠŸèƒ½ç‰¹æ€§
          - ğŸ“± å®æ—¶å±å¹•å…±äº«
          - ğŸ–±ï¸ è¿œç¨‹ç‚¹å‡»æ§åˆ¶
          - ğŸ‘† æ»‘åŠ¨æ“ä½œ
          - âŒ¨ï¸ æŒ‰é”®æ¨¡æ‹Ÿ
          
          ### ä¸‹è½½è¯´æ˜
          - `app-debug.apk`: è°ƒè¯•ç‰ˆæœ¬ï¼Œå¯ç›´æ¥å®‰è£…
          - `app-release-unsigned.apk`: å‘å¸ƒç‰ˆæœ¬ï¼ˆæœªç­¾åï¼‰
          
          ### ä½¿ç”¨æ–¹æ³•
          1. å®‰è£…APKåˆ°Androidè®¾å¤‡
          2. æˆäºˆæˆªå±å’ŒRootæƒé™
          3. è®°å½•è®¾å¤‡IPåœ°å€å’Œç«¯å£
          4. è®¿é—®Webæ§åˆ¶ç«¯è¿›è¡Œè¿æ¥å’Œæ§åˆ¶
          
          ### Webæ§åˆ¶ç«¯
          è®¿é—®ï¼šhttps://github.com/dijiaozhibei-top/Android-control
        files: |
          android-client/app/build/outputs/apk/debug/app-debug.apk
          android-client/app/build/outputs/apk/release/app-release-unsigned.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
