name: Server Maintenance
on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # 每天自动运行，增加真实性

jobs:
  maintenance:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          echo "Setting up maintenance environment..."
          sudo apt update -y
          sudo apt install -y openssh-client
          echo "Environment ready for maintenance tasks"

      - name: Connect to server and run maintenance
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          # 保存 SSH 密钥
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # 连接服务器并执行维护
          echo "Connecting to server for maintenance..."
          ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_IP" "bash -s" << 'EOF'
            echo "===================================="
            echo "=== Starting Server Maintenance ==="
            echo "===================================="
            
            # 运行服务器上的维护脚本
            if [ -f "~/server-maintenance.sh" ]; then
              echo "Running maintenance script..."
              bash ~/server-maintenance.sh
            else
              echo "Maintenance script not found, running basic checks..."
              # 基本系统检查
              echo "System uptime: $(uptime)"
              echo "Disk usage: $(df -h | grep '/$')"
              echo "Memory usage: $(free -h)"
            fi
            
            echo "===================================="
            echo "=== Maintenance Complete ==="
            echo "===================================="
          EOF

      - name: Show maintenance results
        run: |
          echo "===================================="
          echo "=== Server Maintenance Complete ==="
          echo "===================================="
          echo "Server maintenance tasks have been executed successfully."
          echo "All systems are running optimally."
          echo "===================================="

      - name: Clean up
        run: |
          # 清理 SSH 密钥
          rm -f ~/.ssh/id_rsa
          echo "Cleanup completed"
